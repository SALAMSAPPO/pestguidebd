<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pest Guide BD — Final (Excel+CSV, Auto Advisor, Big Header, Logo)</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<!-- XLSX loader for Excel files -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
  :root{
    --green:#2e7d32; --accent:#388e3c; --muted:#f1f1f1;
    --ink:#1f2937; --bg:#f5f7f6;
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:Arial,Helvetica,sans-serif}

  /* ===== Big Header ===== */
  header{
    position:fixed; top:0; left:0; right:0; background:#fff;
    border-bottom:4px solid var(--green); z-index:1000; user-select:none;
  }
  .header-inner{
    display:grid; grid-template-columns:auto 1fr auto; gap:16px; align-items:center;
    padding:18px 18px 16px; min-height:110px;
  }
  .brand-wrap{display:flex; align-items:center; gap:14px}
  .brand-logo{
    width:72px; height:72px; border-radius:18px; border:2px solid #e5efe6; object-fit:cover; background:#e8f5e9;
    box-shadow:0 4px 12px rgba(0,0,0,.08);
  }
  .brand-text{display:flex; flex-direction:column; line-height:1.1}
  .brand-title{font-size:42px; font-weight:900; color:var(--green); letter-spacing:.2px}
  .brand-sub{font-size:14px; color:#4b5563}

  .top-actions{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}
  .btn{border:0; border-radius:10px; padding:10px 14px; font-weight:700; cursor:pointer; display:inline-flex; gap:8px; align-items:center}
  .btn-outline{background:#fff; border:2px solid var(--green); color:var(--green)}
  .btn-outline:hover{background:var(--green); color:#fff}
  .btn-primary{background:var(--accent); color:#fff}
  .btn-muted{background:var(--muted)}
  .btn-danger{background:#e53935; color:#fff}
  .btn-sm{padding:6px 10px; font-weight:600; border-radius:8px}

  main{max-width:1200px; margin:0 auto; padding:160px 14px 24px;}

  /* Admin toolbar */
  .admin-bar{display:none; gap:8px; flex-wrap:wrap; padding:10px; background:#fff; border:1px solid #eaeaea; border-radius:12px; margin-bottom:12px}
  .admin-bar.show{display:flex}

  /* Search row */
  .row{display:flex; align-items:center; gap:8px; flex-wrap:wrap; margin:10px 0}
  input[type="text"], input[type="password"], input[type="email"], input[type="tel"]{padding:8px 10px; border:1px solid #ccc; border-radius:8px; min-width:180px}
  input[readonly]{background:#f7f7f7}

  /* Table */
  .table-wrap{display:none; background:#fff; border:1px solid #e9e9e9; border-radius:12px; overflow:auto; max-height:440px}
  .table-wrap.show{display:block}
  table{width:100%; border-collapse:collapse; font-size:14px}
  th,td{padding:8px 10px; border-bottom:1px solid #eee; text-align:left}
  thead th{position:sticky; top:0; background:#fafafa}
  tr:hover{background:#fbfff7}

  /* Pagination */
  .pager{display:flex; gap:6px; align-items:center; flex-wrap:wrap; padding:8px; font-size:13px}

  /* Toast */
  .toast{position:fixed; bottom:18px; right:18px; padding:10px 14px; border-radius:8px; color:#fff; background:var(--green); opacity:0; transform:translateY(10px); transition:.3s; z-index:9999}
  .toast.show{opacity:1; transform:none}

  /* ===== Modal (Generic) ===== */
  .backdrop{display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:1200; justify-content:center; align-items:flex-start; padding:24px}
  .modal{width:100%; max-width:1000px; max-height:92vh; overflow:auto; background:#fff; border-radius:12px; padding:16px; position:relative}
  .modal h2{margin:0 0 6px 0; color:var(--green)}

  /* ===== Prescription ===== */
  .split{display:grid; grid-template-columns:1fr 1fr; gap:12px}
  .card{border:1px solid #eee; border-radius:12px; padding:12px; background:#fff}
  .card h3{margin:0 0 8px 0; color:#333; font-size:16px}
  .grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:8px}
  label{font-size:12px; color:#555; display:block; margin-bottom:4px}
  select{padding:8px 10px; border:1px solid #ccc; border-radius:8px; min-width:160px; width:100%}
  textarea{width:100%; min-height:70px; padding:8px 10px; border:1px solid #ccc; border-radius:8px}
  .list{border:1px solid #eee; border-radius:8px; padding:8px; background:#fafafa; max-height:220px; overflow:auto}

  .preview{position:relative; background:#fff; border:1px solid #eee; border-radius:8px; padding:12px; min-height:220px; overflow:hidden}
  .wm{position:absolute; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none; font-weight:900; font-size:64px; color:rgba(46,125,50,.07); transform:rotate(-20deg)}

  .sig-row{display:flex; gap:24px; margin-top:14px; flex-wrap:wrap}
  .sig{flex:1}
  .sig .line{border-top:2px solid #444; width:260px; margin-top:48px}
  .sig .cap{font-size:13px; color:#333; font-weight:700; margin-top:6px}

  .warn{margin-top:10px; color:#a33; font-weight:700; font-size:13px}

  /* Registration Modal layout */
  .form-grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:10px}

  /* Login Modal */
  .login-grid{display:grid; grid-template-columns:1fr; gap:10px}

  /* Print */
  @media print{
    @page{ size: 5.25in 8.25in; margin: 8mm; }
    header, .admin-bar, .row, .btn, .toast, #regBackdrop, #loginBackdrop { display:none !important; }
    .modal{box-shadow:none; border:none; padding:0}
    .wm{font-size:60px}
  }

  /* Responsive tweaks */
  @media (max-width: 820px){
    .brand-title{font-size:34px}
    .brand-logo{width:60px;height:60px}
    main{padding-top:170px}
  }
  @media (max-width: 640px){
    .header-inner{grid-template-columns:1fr; gap:10px}
    .top-actions{justify-content:flex-start}
    .brand-title{font-size:30px}
    main{padding-top:190px}
  }
</style>
</head>
<body>

<!-- ===== Header ===== -->
<header>
  <div class="header-inner">
    <div class="brand-wrap">
      <img id="appLogo" class="brand-logo" alt="Logo">
      <div class="brand-text">
        <div class="brand-title">Pest Guide BD</div>
        <div class="brand-sub">বালাইনাশক তথ্য ও প্রেসক্রিপশন</div>
      </div>
    </div>

    <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:center">
      <button id="btnLogoUpload" class="btn btn-outline" title="Set custom logo">
        <i class="fa fa-image"></i> Logo
      </button>
      <button id="btnLogoReset" class="btn btn-muted" title="Reset logo">
        <i class="fa fa-rotate-left"></i> Reset
      </button>
      <input id="logoFile" type="file" accept="image/*" style="display:none">
    </div>

    <div class="top-actions">
      <button id="btnLoginAdmin" class="btn btn-outline"><i class="fa fa-user-shield"></i> Admin Login</button>
      <button id="btnLoginUser" class="btn btn-outline"><i class="fa fa-user"></i> User Login</button>
      <button id="btnRegister" class="btn btn-outline"><i class="fa fa-id-card"></i> Registration</button>
      <button id="btnLogout" class="btn btn-outline" style="display:none;"><i class="fa fa-right-from-bracket"></i> Logout</button>
    </div>
  </div>
</header>

<main>
  <!-- ===== Admin toolbar ===== -->
  <div id="adminBar" class="admin-bar">
    <label for="csvFile" class="btn btn-outline"><i class="fa fa-file-arrow-up"></i> CSV/XLSX Upload</label>
    <input id="csvFile" type="file" accept=".csv,.xlsx,.xls" style="display:none;">

    <button id="btnLoadExcelDemo" class="btn btn-muted" title="Loads sample extracted from your uploaded Excel">
      <i class="fa fa-table"></i> Demo: Your Excel (sample)
    </button>
    <button id="btnLoadDemoBig" class="btn btn-muted" title="Loads synthetic 11k rows to stress test">
      <i class="fa fa-flask"></i> Demo: 11k Rows
    </button>

    <button id="btnToggleTable" class="btn btn-outline"><i class="fa fa-table"></i> Table Show/Hide</button>

    <input id="txtSearch" type="text" placeholder="Search: ফসল/রোগ/ব্র্যান্ড…" />
    <button id="btnSearch" class="btn btn-outline"><i class="fa fa-search"></i> Search</button>
    <button id="btnClear" class="btn btn-muted"><i class="fa fa-eraser"></i> Clear</button>

    <button id="btnAddRow" class="btn btn-primary"><i class="fa fa-plus"></i> Add</button>

    <div class="pager">
      <span>Per page:</span>
      <select id="perPage">
        <option>100</option><option>200</option><option>500</option><option>1000</option>
      </select>
      <button id="prevPage" class="btn btn-sm btn-outline">Prev</button>
      <span id="pageInfo">1/1</span>
      <button id="nextPage" class="btn btn-sm btn-outline">Next</button>
      <span id="loadStat" style="font-size:12px;color:#666"></span>
    </div>
  </div>

  <!-- ===== Table ===== -->
  <div id="tableWrap" class="table-wrap">
    <table id="dataTable">
      <thead id="thead"></thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <!-- ===== Open Prescription ===== -->
  <div class="row">
    <button id="btnOpenPresc" class="btn btn-primary"><i class="fa fa-file-prescription"></i> Prescription</button>
  </div>

  <footer style="text-align:center; color:#666; font-size:13px; margin-top:12px">
    Developed by মোঃ আব্দুস সালাম ©2025
  </footer>
</main>

<!-- ===== Registration Modal ===== -->
<div id="regBackdrop" class="backdrop">
  <div class="modal" style="max-width:720px">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
      <h2>User Registration</h2>
      <button id="btnRegClose" class="btn btn-danger"><i class="fa fa-xmark"></i> Close</button>
    </div>
    <div class="card" style="margin-top:8px">
      <div class="form-grid">
        <div><label>পূর্ণ নাম *</label><input id="regFullName" type="text" placeholder="পূর্ণ নাম"></div>
        <div><label>পদবী *</label><input id="regDesignation" type="text" placeholder="পদবী (যেমন: উপসহকারী কৃষি কর্মকর্তা)"></div>
        <div><label>মোবাইল *</label><input id="regMobile" type="tel" placeholder="মোবাইল"></div>
        <div><label>ইমেইল</label><input id="regEmail" type="email" placeholder="ইমেইল"></div>
        <div><label>ইউজারনেম *</label><input id="regUsername" type="text" placeholder="username"></div>
        <div><label>পাসওয়ার্ড *</label><input id="regPassword" type="password" placeholder="পাসওয়ার্ড"></div>
      </div>
      <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap">
        <button id="btnRegSave" class="btn btn-primary"><i class="fa fa-save"></i> Save</button>
        <button id="btnRegReset" class="btn btn-muted"><i class="fa fa-eraser"></i> Reset</button>
      </div>
      <div style="font-size:12px; color:#666; margin-top:6px">Saved users ব্রাউজারের localStorage-এ সংরক্ষিত থাকবে।</div>
    </div>
  </div>
</div>

<!-- ===== Login Modal (for reliable login) ===== -->
<div id="loginBackdrop" class="backdrop">
  <div class="modal" style="max-width:460px">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:10px">
      <h2 id="loginTitle">Login</h2>
      <button id="btnLoginClose" class="btn btn-danger"><i class="fa fa-xmark"></i> Close</button>
    </div>
    <div class="card" style="margin-top:8px">
      <div class="login-grid">
        <div><label>Username</label><input id="loginUser" type="text" placeholder="username"></div>
        <div><label>Password</label><input id="loginPass" type="password" placeholder="password"></div>
        <div><input id="loginRole" type="hidden" value="user"></div>
      </div>
      <div style="margin-top:10px; display:flex; gap:8px">
        <button id="btnLoginSubmit" class="btn btn-primary"><i class="fa fa-right-to-bracket"></i> Login</button>
        <div id="loginMsg" style="align-self:center; color:#a33; font-weight:600"></div>
      </div>
    </div>
  </div>
</div>

<!-- ===== Prescription Modal ===== -->
<div id="backdrop" class="backdrop">
  <div class="modal">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
      <h2>Pest Guide BD — Prescription</h2>
      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <button id="btnPreview" class="btn btn-muted"><i class="fa fa-eye"></i> Preview</button>
        <button id="btnPrint" class="btn btn-muted"><i class="fa fa-print"></i> Print</button>
        <button id="btnShareWA" class="btn btn-outline"><i class="fa-brands fa-whatsapp"></i> WhatsApp</button>
        <button id="btnShareMessenger" class="btn btn-outline"><i class="fa-brands fa-facebook-messenger"></i> Messenger</button>
        <button id="btnShareEmail" class="btn btn-outline"><i class="fa fa-envelope"></i> Email</button>
        <button id="btnShareCopy" class="btn btn-outline"><i class="fa fa-copy"></i> Copy</button>
        <button id="btnClose" class="btn btn-danger"><i class="fa fa-xmark"></i> Close</button>
      </div>
    </div>

    <div class="split" style="margin-top:8px">
      <!-- Left: Farmer -->
      <div class="card">
        <h3>কৃষকের তথ্য (আবশ্যিক: নাম, মোবাইল)</h3>
        <div class="grid">
          <div><label>কৃষকের নাম *</label><input id="farmerName" type="text" placeholder="কৃষকের নাম লিখুন"></div>
          <div><label>মোবাইল *</label><input id="farmerMobile" type="text" placeholder="মোবাইল নম্বর দিন"></div>
          <div><label>গ্রাম</label><input id="farmerVillage" type="text"></div>
          <div><label>ব্লক</label><input id="farmerBlock" type="text"></div>
          <div><label>ইউনিয়ন</label><input id="farmerUnion" type="text"></div>
          <div><label>উপজেলা</label><input id="farmerUpazila" type="text"></div>
          <div><label>জেলা</label><input id="farmerDistrict" type="text"></div>
        </div>
      </div>

      <!-- Right: Advisor -->
      <div class="card">
        <h3>পরামর্শদাতার তথ্য (অটো)</h3>
        <div class="grid">
          <div><label>পরামর্শ দাতা</label><input id="advisorName" type="text" placeholder="আপনার নাম" readonly></div>
          <div><label>পদবী</label><input id="advisorDesig" type="text" readonly></div>
          <div><label>মোবাইল</label><input id="advisorMobile" type="text" readonly></div>
          <div><label>ইমেইল</label><input id="advisorEmail" type="text" readonly></div>
          <div><label>তারিখ</label><input id="prescDate" type="text" readonly></div>
        </div>

        <h3 style="margin-top:10px;">CSV/XLSX থেকে নির্বাচন</h3>
        <div class="grid">
          <div><label>ফসল</label><select id="selCrop"></select></div>
          <div><label>রোগ/পোকা</label><select id="selPest"></select></div>
          <div><label>সাধারণ নাম</label><select id="selCommon"></select></div>
          <div><label>ব্র্যান্ড  নাম</label><select id="selBrand"></select></div>
          <div><label>প্রয়োগ মাত্রা</label><input id="doseField" type="text" readonly></div>
        </div>

        <div style="display:flex; gap:8px; margin-top:8px; flex-wrap:wrap;">
          <button id="btnAddCrop" class="btn btn-primary"><i class="fa fa-plus-circle"></i> Add Crop</button>
          <span class="badge" id="rowsCountBadge">0 items</span>
        </div>

        <div style="margin-top:8px">
          <label>মন্তব্য (ঐচ্ছিক)</label>
          <textarea id="extraNotes" placeholder="যেমন: সকাল/বিকেল প্রয়োগ করুন…"></textarea>
        </div>
      </div>
    </div>

    <div class="split" style="margin-top:10px">
      <div class="card">
        <h3>Added Crops</h3>
        <div id="addedList" class="list"><div style="color:#777">কোনো ফসল যোগ করা হয়নি।</div></div>
        <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
          <button id="btnRemoveSelected" class="btn btn-muted"><i class="fa fa-trash"></i> Remove Selected</button>
          <button id="btnClearAll" class="btn btn-muted"><i class="fa fa-broom"></i> Clear</button>
        </div>
      </div>

      <div class="card">
        <h3>Preview</h3>
        <div id="previewBox" class="preview">
          <div class="wm">Pest Guide BD</div>
          <div id="previewContent" style="position:relative; z-index:2; color:#222">প্রিভিউ দেখতে <b>Preview</b> বাটনে ক্লিক করুন।</div>
        </div>
      </div>
    </div>

  </div>
</div>

<div id="toast" class="toast"></div>

<script>
/* ===========================
   Keys & State
=========================== */
const LS_USERS = 'pgbd_users';
const SS_AUTH  = 'pgbd_auth';
const LS_PRESC_DRAFT = 'pgbd_presc_draft';
const LS_PRESC_HISTORY = 'pgbd_presc_history';
const LS_LOGO = 'pgbd_logo';

let rowsAll = [];        // full normalized rows
let columns = [];
let isLoggedIn=false, isAdmin=false, currentUser='';
let currentProfile = null; // {username, role, fullName, designation, mobile, email}

let page=1, per=100;
let filteredRows = []; // for pagination

/* ===========================
   Default Logo (inline SVG data URI) + Logo controls
=========================== */
const DEFAULT_LOGO = "data:image/svg+xml;utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='80' height='80' viewBox='0 0 80 80'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0' x2='1' y1='0' y2='1'%3E%3Cstop offset='0%25' stop-color='%237ed957'/%3E%3Cstop offset='100%25' stop-color='%232e7d32'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='80' height='80' rx='16' fill='url(%23g)'/%3E%3Cpath d='M20 50c10-20 30-25 40-22-8 8-16 12-23 14 8 1 16 4 22 10-12 3-24 3-39-2z' fill='%23e8f5e9' opacity='.85'/%3E%3Ccircle cx='28' cy='28' r='6' fill='%23fff' opacity='.9'/%3E%3C/svg%3E";
function loadLogo(){
  const saved = localStorage.getItem(LS_LOGO);
  document.getElementById('appLogo').src = saved || DEFAULT_LOGO;
}
function fileToDataURL(file){
  return new Promise((res,rej)=>{
    const fr=new FileReader();
    fr.onload=()=>res(fr.result);
    fr.onerror=rej;
    fr.readAsDataURL(file);
  });
}
document.getElementById('btnLogoUpload').addEventListener('click', ()=>document.getElementById('logoFile').click());
document.getElementById('logoFile').addEventListener('change', async (e)=>{
  const f=e.target.files[0]; if(!f) return;
  const data=await fileToDataURL(f);
  localStorage.setItem(LS_LOGO, data);
  loadLogo();
  showToast('Logo saved');
  e.target.value='';
});
document.getElementById('btnLogoReset').addEventListener('click', ()=>{
  localStorage.removeItem(LS_LOGO);
  loadLogo();
  showToast('Logo reset');
});

/* ===========================
   Utils
=========================== */
const $ = sel => document.querySelector(sel);
function showToast(msg){ const t=$("#toast"); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 2200); }
function esc(s){ if(s===0) return '0'; if(!s) return ''; return String(s).replace(/[&<>"]/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m])); }
function todayStr(){ return new Date().toLocaleDateString('bn-BD'); }

function saveJSON(key, val){ localStorage.setItem(key, JSON.stringify(val)); }
function loadJSON(key, def=null){ try{ const x=localStorage.getItem(key); return x?JSON.parse(x):def; }catch(e){ return def; }}

/* ===========================
   Users (seed + local)
=========================== */
const SEED = [
  {username:'admin', password:'admin123', role:'admin', fullName:'মোঃ আব্দুস সালাম', designation:'Admin', mobile:'01716560306', email:'salamsappo@gmail.com'},
  {username:'user',  password:'user123',  role:'user',  fullName:'Demo User',  designation:'', mobile:'', email:''}
];
function getUsers(){
  const local = loadJSON(LS_USERS, []);
  // de-dup by username (local overrides seed)
  const map = new Map();
  SEED.forEach(u=>map.set(u.username, u));
  local.forEach(u=>map.set(u.username, u));
  return Array.from(map.values());
}
function saveUser(u){
  const list=getUsers();
  if(list.some(x=>x.username===u.username)){
    // replace
    const out=list.map(x=>x.username===u.username?u:x);
    saveJSON(LS_USERS, out.filter(x=>!SEED.find(s=>s.username===x.username))); // only non-seed in LS
  }else{
    const local = loadJSON(LS_USERS, []);
    local.push(u); saveJSON(LS_USERS, local);
  }
}

/* ===========================
   Auth state + Login Modal
=========================== */
function persistLogin(){ sessionStorage.setItem(SS_AUTH, JSON.stringify({isLoggedIn,isAdmin,currentUser})); }
function loadLogin(){
  const raw=sessionStorage.getItem(SS_AUTH);
  if(raw){ const s=JSON.parse(raw); isLoggedIn=!!s.isLoggedIn; isAdmin=!!s.isAdmin; currentUser=s.currentUser||''; }
  currentProfile = isLoggedIn ? getUsers().find(u=>u.username===currentUser) || null : null;
  toggleAuthUI();
  fillAdvisorFromProfile(); // keep advisor fields synced
}

function doLogin(role, username, password){
  const user = getUsers().find(x=>x.username===username && x.password===password && x.role===role);
  if(user){
    isLoggedIn=true; isAdmin=(role==='admin'); currentUser=username; currentProfile=user;
    toggleAuthUI(); persistLogin(); showToast('Login success');
    $('#loginBackdrop').style.display='none';
  } else {
    $('#loginMsg').textContent='Invalid credentials';
  }
}
function doLogout(){ isLoggedIn=false; isAdmin=false; currentUser=''; currentProfile=null; toggleAuthUI(); persistLogin(); showToast('Logged out'); }

function toggleAuthUI(){
  // header buttons
  $("#btnLoginAdmin").style.display = isLoggedIn?'none':'inline-flex';
  $("#btnLoginUser").style.display  = isLoggedIn?'none':'inline-flex';
  $("#btnRegister").style.display   = isLoggedIn?'none':'inline-flex';
  $("#btnLogout").style.display     = isLoggedIn?'inline-flex':'none';

  // admin bar & table visibility
  $("#adminBar").classList.toggle('show', isLoggedIn && isAdmin);
  $("#tableWrap").classList.toggle('show', isLoggedIn && isAdmin && filteredRows.length>0);

  // Advisor prefill (name + designation + mobile + email)
  fillAdvisorFromProfile();
}

/* Advisor auto-fill from profile */
function fillAdvisorFromProfile(){
  const advName = currentProfile ? (currentProfile.fullName || '') : '';
  const advDes  = currentProfile ? (currentProfile.designation || '') : '';
  const advMob  = currentProfile ? (currentProfile.mobile || '') : '';
  const advMail = currentProfile ? (currentProfile.email || '') : '';
  $("#advisorName").value = isLoggedIn ? advName : '';
  $("#advisorDesig").value = isLoggedIn ? advDes : '';
  $("#advisorMobile").value = isLoggedIn ? advMob : '';
  $("#advisorEmail").value = isLoggedIn ? advMail : '';
}

/* ===========================
   CSV/XLSX: normalize & load (large)
=========================== */
const CANON = {
  crop:'ফসল', pest:'রোগ/পোকা', common:'সাধারণ নাম', brand:'ব্র্যান্ড নাম', dose:'প্রয়োগ মাত্রা'
};
const ALIASES = {
  'ফসল':'ফসল','crop':'ফসল','crops':'ফসল','শস্য':'ফসল',
  'রোগ':'রোগ/পোকা','পোকা':'রোগ/পোকা','pest':'রোগ/পোকা','disease':'রোগ/পোকা','রোগ/পোকা':'রোগ/পোকা',
  'সাধারণ নাম':'সাধারণ নাম','common':'সাধারণ নাম','common name':'সাধারণ নাম','generic':'সাধারণ নাম',
  'ব্র্যান্ড নাম':'ব্র্যান্ড নাম','ব্রান্ড নাম':'ব্র্যান্ড নাম','brand':'ব্র্যান্ড নাম','trade name':'ব্র্যান্ড নাম',
  'প্রয়োগ মাত্রা':'প্রয়োগ মাত্রা','মাত্রা':'প্রয়োগ মাত্রা','dose':'প্রয়োগ মাত্রা','dosage':'প্রয়োগ মাত্রা','application rate':'প্রয়োগ মাত্রা'
};
function normKey(k){
  if(!k) return k;
  const s = String(k).trim().toLowerCase().replace(/\s+/g,' ');
  return ALIASES[s] || ALIASES[s.replace(/[._-]/g,' ')] || k.trim();
}
function normalizeRow(r){
  const out={}; Object.keys(r).forEach(k=>{
    const nk = normKey(k);
    out[nk]=r[k];
  });
  return out;
}

function rebuildView(rows){
  rowsAll = rows;
  filteredRows = rows.slice();
  columns = Object.keys(rows[0]||{});
  page=1;
  renderPage();
  populateCascade();
  $("#rowsCountBadge").textContent = `${rowsAll.length} items`;
  $("#tableWrap").classList.toggle('show', isLoggedIn && isAdmin && filteredRows.length>0);
}

function renderPage(){
  const thead=$("#thead"), tbody=$("#tbody");
  thead.innerHTML=''; tbody.innerHTML='';
  const total = filteredRows.length;
  const pages = Math.max(1, Math.ceil(total/per));
  if(page>pages) page=pages;
  const start = (page-1)*per, end=Math.min(total, start+per);
  const rows = filteredRows.slice(start, end);

  if(!rows.length){ thead.innerHTML='<tr><th>খালি</th></tr>'; $("#pageInfo").textContent=`0/0`; return; }

  // header
  const trh = document.createElement('tr');
  columns.forEach(c=>{ const th=document.createElement('th'); th.textContent=c; trh.appendChild(th); });
  if(isAdmin){ const th=document.createElement('th'); th.textContent='Actions'; trh.appendChild(th); }
  thead.appendChild(trh);

  // body
  rows.forEach((r,i)=>{
    const tr=document.createElement('tr');
    columns.forEach(c=>{ const td=document.createElement('td'); td.textContent=r[c]||''; td.title=r[c]||''; tr.appendChild(td); });
    if(isAdmin){
      const td=document.createElement('td');
      const btnE=document.createElement('button'); btnE.className='btn btn-outline btn-sm'; btnE.innerHTML='<i class="fa fa-pen"></i>'; btnE.title='Edit';
      btnE.onclick=()=>editRow(start+i);
      const btnD=document.createElement('button'); btnD.className='btn btn-danger btn-sm'; btnD.innerHTML='<i class="fa fa-trash"></i>'; btnD.title='Delete';
      btnD.onclick=()=>{ if(confirm('ডিলিট করবেন?')){ rowsAll.splice(start+i,1); filteredRows=rowsAll.slice(); rebuildView(rowsAll); } };
      td.appendChild(btnE); td.appendChild(btnD); tr.appendChild(td);
    }
    tbody.appendChild(tr);
  });

  $("#pageInfo").textContent = `${page}/${pages}`;
}
$("#perPage").addEventListener('change', (e)=>{ per=parseInt(e.target.value,10)||100; renderPage(); });
$("#prevPage").addEventListener('click', ()=>{ if(page>1){ page--; renderPage(); }});
$("#nextPage").addEventListener('click', ()=>{ const pages=Math.max(1,Math.ceil(filteredRows.length/per)); if(page<pages){ page++; renderPage(); }});

function parseCSVText(text){
  const parsed = Papa.parse(text, {header:true, skipEmptyLines:true});
  const rows = parsed.data.map(normalizeRow).filter(r=>Object.keys(r).length>0);
  if(!rows.length){ showToast('CSV খালি'); return; }
  // ensure canonical columns exist
  const cols = new Set();
  rows.forEach(r=>Object.keys(r).forEach(k=>cols.add(k)));
  [CANON.crop, CANON.pest, CANON.common, CANON.brand, CANON.dose].forEach(k=>cols.add(k));
  columns = Array.from(cols);
  rebuildView(rows);
  showToast('CSV Loaded');
}

function parseCSVFile(file){
  const big = file.size > 1024*1024; // >1MB -> stream
  $("#loadStat").textContent = big ? 'Loading (stream)...' : 'Loading...';
  let count=0, acc=[];
  Papa.parse(file, {
    header:true, skipEmptyLines:true, worker:true,
    chunk: (res)=>{ 
      const rows = res.data.map(normalizeRow);
      acc.push(...rows); count+=rows.length;
      $("#loadStat").textContent = `Loaded: ${count.toLocaleString('bn-BD')} rows`;
    },
    complete: ()=>{ $("#loadStat").textContent=''; rebuildView(acc); showToast('CSV Loaded'); },
    error: (e)=>{ $("#loadStat").textContent=''; showToast('CSV লোডে সমস্যা: '+e.message); }
  });
}

/* XLSX parser */
async function parseXLSXFile(file){
  $("#loadStat").textContent = 'Reading Excel...';
  const data = await file.arrayBuffer();
  const wb = XLSX.read(data, {type:'array'});
  const sheetName = wb.SheetNames[0]; // first sheet
  const ws = wb.Sheets[sheetName];
  const json = XLSX.utils.sheet_to_json(ws, {defval:''}); // array of objects
  const rows = json.map(normalizeRow);
  $("#loadStat").textContent = '';
  rebuildView(rows);
  showToast('Excel Loaded');
}

/* File input & Demos */
$("#csvFile").addEventListener('change', e=>{
  const f=e.target.files[0]; if(!f) return;
  const name=f.name.toLowerCase();
  if(name.endsWith('.xlsx')||name.endsWith('.xls')) parseXLSXFile(f);
  else parseCSVFile(f);
  e.target.value='';
});
$("#btnLoadExcelDemo").addEventListener('click', ()=> parseCSVText(demoCSVFromExcel)); // sample from your Excel (embedded)
$("#btnLoadDemoBig").addEventListener('click', ()=> parseCSVText(buildDemoCSV11000())); // 11k synthetic
$("#btnToggleTable").addEventListener('click', ()=> $("#tableWrap").classList.toggle('show'));
$("#btnSearch").addEventListener('click', ()=> doSearch());
$("#btnClear").addEventListener('click', ()=>{ $("#txtSearch").value=''; filteredRows=rowsAll.slice(); page=1; renderPage(); });

function doSearch(){
  const q=($("#txtSearch").value||'').toLowerCase().trim();
  filteredRows = q ? rowsAll.filter(r=>Object.values(r).some(v=>(v||'').toString().toLowerCase().includes(q))) : rowsAll.slice();
  page=1; renderPage();
}
function editRow(i){
  const r = rowsAll[i]; if(!r) return;
  const keys = [CANON.crop, CANON.pest, CANON.common, CANON.brand, CANON.dose];
  keys.forEach(k=>{ const v=prompt(k+' =', r[k]||''); if(v!==null) r[k]=v; });
  rebuildView(rowsAll);
}
$("#btnAddRow").addEventListener('click', ()=>{
  const r = {[CANON.crop]:'',[CANON.pest]:'',[CANON.common]:'',[CANON.brand]:'',[CANON.dose]:''};
  Object.keys(r).forEach(k=>{ const v=prompt(k+' =', ''); if(v!==null) r[k]=v; });
  rowsAll.push(r); filteredRows=rowsAll.slice(); rebuildView(rowsAll);
});

/* ===========================
   Prescription: cascading selects
=========================== */
function setOpts(sel, arr, placeholder){
  sel.innerHTML='';
  const o0=document.createElement('option'); o0.value=''; o0.textContent=placeholder; sel.appendChild(o0);
  Array.from(new Set(arr.filter(Boolean))).sort().forEach(v=>{
    const o=document.createElement('option'); o.value=v; o.textContent=v; sel.appendChild(o);
  });
}
function populateCascade(){
  const src = rowsAll;
  setOpts($("#selCrop"),  src.map(r=>r[CANON.crop]), 'ফসল নির্বাচন');
  setOpts($("#selPest"),  [], 'রোগ/পোকা নির্বাচন');
  setOpts($("#selCommon"),[], 'সাধারণ নাম নির্বাচন');
  setOpts($("#selBrand"), [], 'ব্র্যান্ড নাম নির্বাচন');
  $("#doseField").value='';
}
$("#selCrop").addEventListener('change', ()=>{
  const crop=$("#selCrop").value; const src=rowsAll;
  setOpts($("#selPest"),  src.filter(r=>r[CANON.crop]===crop).map(r=>r[CANON.pest]), 'রোগ/পোকা নির্বাচন');
  setOpts($("#selCommon"),[], 'সাধারণ নাম নির্বাচন');
  setOpts($("#selBrand"), [], 'ব্র্যান্ড নাম নির্বাচন');
  $("#doseField").value='';
});
$("#selPest").addEventListener('change', ()=>{
  const crop=$("#selCrop").value, pest=$("#selPest").value; const src=rowsAll;
  setOpts($("#selCommon"), src.filter(r=>r[CANON.crop]===crop && r[CANON.pest]===pest).map(r=>r[CANON.common]), 'সাধারণ নাম নির্বাচন');
  setOpts($("#selBrand"),[], 'ব্র্যান্ড নাম নির্বাচন'); $("#doseField").value='';
});
$("#selCommon").addEventListener('change', ()=>{
  const crop=$("#selCrop").value, pest=$("#selPest").value, common=$("#selCommon").value; const src=rowsAll;
  setOpts($("#selBrand"), src.filter(r=>r[CANON.crop]===crop && r[CANON.pest]===pest && r[CANON.common]===common).map(r=>r[CANON.brand]), 'ব্র্যান্ড নাম নির্বাচন');
  $("#doseField").value='';
});
$("#selBrand").addEventListener('change', ()=>{
  const crop=$("#selCrop").value, pest=$("#selPest").value, common=$("#selCommon").value, brand=$("#selBrand").value;
  const src=rowsAll;
  let r=src.find(x=>x[CANON.crop]===crop && x[CANON.pest]===pest && x[CANON.common]===common && x[CANON.brand]===brand);
  if(!r) r=src.find(x=>x[CANON.crop]===crop && x[CANON.pest]===pest && x[CANON.brand]===brand);
  $("#doseField").value = r ? (r[CANON.dose]||'') : '';
});

/* ===========================
   Prescription: list + draft autosave
=========================== */
let added = loadJSON(LS_PRESC_DRAFT, []); // restore draft if any
function refreshAdded(){
  const box=$("#addedList");
  box.innerHTML='';
  if(!added.length){ box.innerHTML='<div style="color:#777">কোনো ফসল যোগ করা হয়নি।</div>'; return; }
  added.forEach((it,i)=>{
    const row=document.createElement('div');
    row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center';
    row.style.gap='6px'; row.style.padding='4px 0'; row.style.borderBottom='1px solid #eee';
    row.innerHTML = `<span>${esc(it[CANON.crop])} | ${esc(it[CANON.pest])} | ${esc(it[CANON.common])} | ${esc(it[CANON.brand])} | ${esc(it[CANON.dose])}</span>
                     <input type="checkbox" data-i="${i}">`;
    box.appendChild(row);
  });
  saveJSON(LS_PRESC_DRAFT, added); // draft autosave on every render
}
$("#btnAddCrop").addEventListener('click', ()=>{
  const crop=$("#selCrop").value, pest=$("#selPest").value, common=$("#selCommon").value, brand=$("#selBrand").value, dose=$("#doseField").value;
  if(!crop || !pest){ showToast('ফসল ও রোগ/পোকা নির্বাচন করুন'); return; }
  added.push({[CANON.crop]:crop, [CANON.pest]:pest, [CANON.common]:common||'', [CANON.brand]:brand||'', [CANON.dose]:dose||''});
  refreshAdded();
});
$("#btnRemoveSelected").addEventListener('click', ()=>{
  const checks = Array.from($("#addedList").querySelectorAll('input[type=checkbox]:checked')).map(c=>parseInt(c.dataset.i)).sort((a,b)=>b-a);
  checks.forEach(i=>added.splice(i,1));
  refreshAdded();
});
$("#btnClearAll").addEventListener('click', ()=>{ added=[]; refreshAdded(); });

/* ===========================
   Preview (with required check)
=========================== */
function buildPreviewHTML(){
  // Required check
  const farmerName = $("#farmerName").value.trim();
  const farmerMobile = $("#farmerMobile").value.trim();
  if(!farmerName || !farmerMobile){
    return `<div style="color:#b00020"><b>কৃষকের নাম</b> ও <b>মোবাইল</b> আবশ্যিক! অনুগ্রহ করে পূরণ করুন।</div>`;
  }

  // Advisor prefill (from currentProfile)
  const advName = $("#advisorName").value || '';
  const advDes  = $("#advisorDesig").value || '';
  const advMob  = $("#advisorMobile").value || '';
  const advMail = $("#advisorEmail").value || '';

  const infoLeft = `
    <div><b>কৃষকের নাম:</b> ${esc(farmerName)}</div>
    <div><b>মোবাইল:</b> ${esc(farmerMobile)}</div>
    <div><b>গ্রাম:</b> ${esc($("#farmerVillage").value)}</div>
    <div><b>ব্লক:</b> ${esc($("#farmerBlock").value)}</div>
    <div><b>ইউনিয়ন:</b> ${esc($("#farmerUnion").value)}</div>
    <div><b>উপজেলা:</b> ${esc($("#farmerUpazila").value)}</div>
    <div><b>জেলা:</b> ${esc($("#farmerDistrict").value)}</div>
  `;
  const infoRight = `
    <div><b>পরামর্শ দাতা:</b> ${esc(advName)}</div>
    <div><b>পদবী:</b> ${esc(advDes)}</div>
    <div><b>মোবাইল:</b> ${esc(advMob)}</div>
    <div><b>ইমেইল:</b> ${esc(advMail)}</div>
    <div><b>তারিখ:</b> ${esc($("#prescDate").value)}</div>
  `;

  // Table
  let table = `
    <table style="width:100%; border-collapse:collapse; margin-top:6px">
      <thead>
        <tr style="background:#f4fff4">
          <th style="border:1px solid #ddd; padding:6px; text-align:left;">ফসল</th>
          <th style="border:1px solid #ddd; padding:6px; text-align:left;">রোগ/পোকা</th>
          <th style="border:1px solid #ddd; padding:6px; text-align:left;">সাধারণ নাম</th>
          <th style="border:1px solid #ddd; padding:6px; text-align:left;">ব্র্যান্ড নাম</th>
          <th style="border:1px solid #ddd; padding:6px; text-align:left;">প্রয়োগ মাত্রা</th>
        </tr>
      </thead>
      <tbody>
  `;
  if(!added.length){
    table += `<tr><td colspan="5" style="border:1px solid #ddd; padding:8px; text-align:center; color:#777">কোনো আইটেম নেই</td></tr>`;
  }else{
    added.forEach(r=>{
      table += `<tr>
        <td style="border:1px solid #ddd; padding:6px;">${esc(r[CANON.crop])}</td>
        <td style="border:1px solid #ddd; padding:6px;">${esc(r[CANON.pest])}</td>
        <td style="border:1px solid #ddd; padding:6px;">${esc(r[CANON.common])}</td>
        <td style="border:1px solid #ddd; padding:6px;">${esc(r[CANON.brand])}</td>
        <td style="border:1px solid #ddd; padding:6px;">${esc(r[CANON.dose])}</td>
      </tr>`;
    });
  }
  table += `</tbody></table>`;

  const notes = $("#extraNotes").value ? `<div style="margin-top:8px;"><b>মন্তব্য:</b> ${esc($("#extraNotes").value)}</div>` : '';

  const sig = `
    <div class="sig-row">
    <div class="sig"><div class="line"></div><div class="cap"></div></div>
    </div>
  `;
  const warn = `
    <div class="warn">
      বালাইনাশক প্রয়োগের আগে অবশ্যই লেবেলের নির্দেশনা মেনে চলুন।<br/>
      শিশু, গৃহপালিত পশু ও পাখির নাগালের বাইরে রাখুন।<br/>
      প্রয়োগকালে মুখে মাস্ক, চোখে চশমা ও হাতে গ্লাভস ব্যবহার করুন।<br/>
      বাতাসের দিক অনুযায়ী প্রয়োগ করুন, পানির উৎসে ছিটানো এড়িয়ে চলুন।
    </div>
  `;

  // Header block for print/share (with logo)
  const logo = $("#appLogo").src || '';
  const headerBlock = `
    <div style="display:flex; align-items:center; gap:10px; justify-content:center; margin-bottom:4px">
      ${logo ? `<img src="${logo}" style="width:42px;height:42px;border-radius:10px;border:1px solid #e5efe6;object-fit:cover">` : ``}
      <div style="text-align:center">
        <div style="font-weight:900; font-size:20px; color:#2e7d32">Pest Guide BD</div>
        <div style="font-weight:700;">বালাইনাশক প্রেসক্রিপসন</div>
      </div>
    </div>
  `;

  return `
    ${headerBlock}
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:6px">
      <div>${infoLeft}</div>
      <div>${infoRight}</div>
    </div>
    ${table}
    ${notes}
    ${sig}
    ${warn}
  `;
}
function updatePreview(){ $("#previewContent").innerHTML = buildPreviewHTML(); }

/* ===========================
   Print / Share (+ Auto-Save to History on print)
=========================== */
function doPrint(){
  const html = buildPreviewHTML(); // সতর্কতা ও table content
  if(/আবশ্যিক/.test(html)){ showToast('কৃষকের নাম ও মোবাইল পূরণ করুন'); return; }

  // Auto-save to history
  const record = {
    ts: new Date().toISOString(),
    farmer: {
      name: $("#farmerName").value, mobile: $("#farmerMobile").value,
      village: $("#farmerVillage").value, block: $("#farmerBlock").value,
      union: $("#farmerUnion").value, upazila: $("#farmerUpazila").value, district: $("#farmerDistrict").value
    },
    advisor: {
      name: $("#advisorName").value, designation: $("#advisorDesig").value,
      mobile: $("#advisorMobile").value, email: $("#advisorEmail").value
    },
    date: $("#prescDate").value,
    items: added,
    notes: $("#extraNotes").value
  };
  const hist = loadJSON(LS_PRESC_HISTORY, []);
  hist.push(record); saveJSON(LS_PRESC_HISTORY, hist);

  const w = window.open('', '', 'width=720,height=900');
  w.document.write(`<!DOCTYPE html><html><head><meta charset="utf-8">
    <title>Prescription</title>
    <style>
      @page{ size: 8.25in 5.75in; margin:5mm; }
      body{
        font-family:Arial,Helvetica,sans-serif; 
        color:#222; 
        font-size:11px; 
        line-height:1.1;
      }
      .wm{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; font-weight:900; font-size:45px; color:rgba(46,125,50,.07); transform:rotate(-20deg); pointer-events:none;}
      table{ width:100%; border-collapse:collapse; font-size:10px; }
      th,td{ border:1px solid #ddd; padding:3px; text-align:left; }
      .sig-container{
        display:flex;
        flex-direction:column;
        align-items:flex-end; /* ডানদিকে */
        margin-top:8px;
      }
      .sig-info{ font-size:11px; text-align:right; margin-bottom:4px; }
      .sig{ display:inline-block; width:180px; }
      .sig .line{ border-top:2px solid #444; margin-top:10px }
      .cap{ font-size:11px; font-weight:700; margin-top:3px; text-align:center; }
      .warn{ margin-top:6px; color:#a33; font-weight:700; font-size:11px }
      .head{ display:flex; align-items:center; gap:8px; justify-content:center; margin-bottom:4px }
      .head img{ width:32px; height:32px; border-radius:8px; border:1px solid #e5efe6; object-fit:cover }
      .title{ text-align:center; }
      .title .t1{ font-weight:900; font-size:16px; color:#2e7d32 }
      .title .t2{ font-weight:700; font-size:11px }
    </style>
  </head><body>
    <div class="wm">Pest Guide BD</div>
    ${html}  <!-- buildPreviewHTML() থেকে content, সতর্কতা সহ -->
    
    <!-- Signature section only, ডানদিকে -->
    <div class="sig-container">
      <div class="sig-info">
        <div>স্বাক্ষর: ${$("#advisorName").value}</div>
        <div>তারিখ: ${$("#prescDate").value}</div>
          </div>

  </body></html>`);
  w.document.close(); w.focus(); w.print();
}

function buildShareText(){
  const html = buildPreviewHTML();
  if(/আবশ্যিক/.test(html)){ return null; }
  const advName = $("#advisorName").value || '';
  const advDes  = $("#advisorDesig").value || '';
  const advMob  = $("#advisorMobile").value || '';
  const advMail = $("#advisorEmail").value || '';
  const farmer = `কৃষক: ${$("#farmerName").value} (${$("#farmerMobile").value})`;
  const head1 = `Pest Guide BD`; const head2 = `বালাইনাশক প্রেসক্রিপসন`;
  const advLine = `পরামর্শ দাতা: ${advName}${advDes?', '+advDes:''}${advMob?' | মোবাইল: '+advMob:''}${advMail?' | ইমেইল: '+advMail:''} | তারিখ: ${$("#prescDate").value}`;
  const lines = added.length ? added.map(r=>`• ${r[CANON.crop]} | ${r[CANON.pest]} | ${r[CANON.common]} | ${r[CANON.brand]} | ${r[CANON.dose]}`) : ['— কোনো আইটেম নেই —'];
  const notes = $("#extraNotes").value ? `\nমন্তব্য: ${$("#extraNotes").value}` : '';
  const warn = `\n\nসতর্কতা: লেবেলের নির্দেশনা মানুন; শিশু/পশুপাখি থেকে দূরে রাখুন; PPE ব্যবহার করুন; বাতাসের দিক অনুযায়ী প্রয়োগ করুন; পানির উৎসে ছিটানো এড়িয়ে চলুন।`;
  return `${head1}\n${head2}\n${farmer}\n${advLine}\n${lines.join('\n')}${notes}${warn}`;
}
function shareWhatsApp(){
  const text = buildShareText(); if(!text){ showToast('কৃষকের নাম/মোবাইল দিন'); return; }
  const url = `https://wa.me/?text=${encodeURIComponent(text)}`;
  window.open(url,'_blank');
}
function shareEmail(){
  const text = buildShareText(); if(!text){ showToast('কৃষকের নাম/মোবাইল দিন'); return; }
  const subj = 'Pest Guide BD — Prescription';
  const url = `mailto:?subject=${encodeURIComponent(subj)}&body=${encodeURIComponent(text)}`;
  window.location.href = url;
}
function shareCopy(){
  const text = buildShareText(); if(!text){ showToast('কৃষকের নাম/মোবাইল দিন'); return; }
  navigator.clipboard.writeText(text).then(()=>showToast('Copied to clipboard'));
}
function shareMessenger(){
  const text = buildShareText(); if(!text){ showToast('কৃষকের নাম/মোবাইল দিন'); return; }
  if (navigator.share){
    navigator.share({title:'Pest Guide BD — Prescription', text})
      .catch(()=>{});
    return;
  }
  const ua = navigator.userAgent.toLowerCase();
  const onMobile = /android|iphone|ipad|ipod/.test(ua);
  if(onMobile){
    const deeplink = `fb-messenger://share/?link=${encodeURIComponent('https://example.com')}&app_id=0`;
    window.location.href = deeplink;
    navigator.clipboard.writeText(text).finally(()=>showToast('Messenger খোলার চেষ্টা হয়েছে; টেক্সট কপি করা হলো'));
    return;
  }
  navigator.clipboard.writeText(text).then(()=>showToast('টেক্সট কপি হয়েছে—Messenger-এ পেস্ট করুন'));
}

/* ===========================
   Modal open/close + init
=========================== */
const regBackdrop = $("#regBackdrop");
$("#btnRegister").addEventListener('click', ()=>{ regBackdrop.style.display='flex'; });
$("#btnRegClose").addEventListener('click', ()=>{ regBackdrop.style.display='none'; });
$("#btnRegReset").addEventListener('click', ()=>{
  ["regFullName","regDesignation","regMobile","regEmail","regUsername","regPassword"].forEach(id=>$("#"+id).value='');
});
$("#btnRegSave").addEventListener('click', ()=>{
  const fullName=$("#regFullName").value.trim();
  const designation=$("#regDesignation").value.trim();
  const mobile=$("#regMobile").value.trim();
  const email=$("#regEmail").value.trim();
  const username=$("#regUsername").value.trim();
  const password=$("#regPassword").value;

  if(!fullName || !designation || !mobile || !username || !password){
    showToast('দয়া করে * চিহ্নিত ঘরগুলো পূরণ করুন'); return;
  }
  const list=getUsers();
  if(list.some(u=>u.username===username)){ showToast('Username already exists'); return; }

  saveUser({username, password, role:'user', fullName, designation, mobile, email});
  showToast('Registration saved');
  regBackdrop.style.display='none';
});

/* Login Modal handlers */
const loginBackdrop=$("#loginBackdrop");
$("#btnLoginAdmin").addEventListener('click', ()=>{ $("#loginTitle").textContent='Admin Login'; $("#loginRole").value='admin'; $("#loginUser").value=''; $("#loginPass").value=''; $("#loginMsg").textContent=''; loginBackdrop.style.display='flex'; });
$("#btnLoginUser").addEventListener('click',  ()=>{ $("#loginTitle").textContent='User Login';  $("#loginRole").value='user';  $("#loginUser").value=''; $("#loginPass").value=''; $("#loginMsg").textContent=''; loginBackdrop.style.display='flex'; });
$("#btnLoginClose").addEventListener('click', ()=> loginBackdrop.style.display='none');
$("#btnLoginSubmit").addEventListener('click', ()=>{
  const role=$("#loginRole").value; const u=$("#loginUser").value.trim(); const p=$("#loginPass").value;
  if(!u || !p){ $("#loginMsg").textContent='Fill username/password'; return; }
  doLogin(role, u, p);
});
$("#btnLogout").addEventListener('click', doLogout);

/* Prescription modal */
const backdrop = $("#backdrop");
$("#btnOpenPresc").addEventListener('click', ()=>{
  $("#prescDate").value = todayStr();
  fillAdvisorFromProfile(); // ensure advisor fields are updated
  backdrop.style.display='flex';
  refreshAdded(); // ensure draft shows
});
$("#btnClose").addEventListener('click', ()=> backdrop.style.display='none');

$("#btnPreview").addEventListener('click', updatePreview);
$("#btnPrint").addEventListener('click', doPrint);
$("#btnShareWA").addEventListener('click', shareWhatsApp);
$("#btnShareMessenger").addEventListener('click', shareMessenger);
$("#btnShareEmail").addEventListener('click', shareEmail);
$("#btnShareCopy").addEventListener('click', shareCopy);

/* Live minimal validation hint */
["farmerName","farmerMobile"].forEach(id=>{
  document.getElementById(id).addEventListener('input', ()=>{
    const v=document.getElementById(id).value.trim();
    document.getElementById(id).style.borderColor = v? '#ccc' : '#e53935';
  });
});

/* ===========================
   Demos
   1) demoCSVFromExcel — sample extracted from your provided Excel (embedded inline)
   2) buildDemoCSV11000 — synthetic 11k rows stress-test
=========================== */

/* 1) Your Excel (sample) — ৪০০ রো এমবেড করা হয়েছে (পুরো ফাইল বড় হওয়ায় সম্পূর্ণটি ইনলাইন করা হয়নি) */
const demoCSVFromExcel = `
ফসল,রোগ/পোকা,সাধারণ নাম,ব্র্যান্ড নাম,প্রয়োগ মাত্রা
ধান,ব্লাস্ট,ট্রাইসাইক্লাজোল,ব্লাজো ৭৫ডব্লিউপি,১ গ্রাম/লিটার
ধান,ব্লাস্ট,ট্রাইসাইক্লাজোল,ট্রাইসাইকিল ৭৫ডব্লিউপি,১ গ্রাম/লিটার
ধান,ব্লাস্ট,ট্রাইসাইক্লাজোল,ট্রাইম্যাক্স ৭৫ডব্লিউপি,১ গ্রাম/লিটার
ধান,পাতাঝল,টেবুকোনাজোল,ফলিকিউর ২৫ইসি,১ মিলি/লিটার
ধান,পাতাঝল,প্রোপিকোনাজোল,টিল্ট ২৫ইসি,১ মিলি/লিটার
ধান,স্টেম বোরার,ক্লোরান্ট্রানিলিপ্রোল,করাগান্টা ২০এসসি,০.৩ মিলি/লিটার
গম,পাতাঝল,টেবুকোনাজোল,ফলিকিউর ২৫ইসি,১ মিলি/লিটার
সবজি,লিফ মাইনার,অ্যাবামেক্টিন,ভার্টিমেক ১.৮ইসি,০.৫ মিলি/লিটার
সবজি,মাইট,প্রোপারগাইট,ওমাইট ৫৭ইসি,১ মিলি/লিটার
পেঁয়াজ,থ্রিপস,স্পিনোস্যাড,ট্রেসার ৪৫এসসি,০.২৫ মিলি/লিটার
বেগুন,বিএফএসবি,সাইপারমেথ্রিন,সাইপার ১০ইসি,১ মিলি/লিটার
আলু,লেট ব্লাইট,ম্যানকোজেব,ডাইথেন এম-৪৫,২ গ্রাম/লিটার
আলু,আর্লি ব্লাইট,ক্লোরোথালোনিল,ড্যাকোনিল ৭৫ডব্লিউপি,২ গ্রাম/লিটার
টমেটো,টিএসএম (মাইট),অ্যাবামেক্টিন,ভার্টিমেক ১.৮ইসি,০.৫ মিলি/লিটার
টমেটো,ফল পচা,কারবেন্ডাজিম,বাভিস্টিন ৫০ডব্লিউপি,১ গ্রাম/লিটার
চা,লোপার,ল্যাম্বডা-সাইহ্যালোথ্রিন,করাটে ২.৫ডব্লিউজি,০.৫ গ্রাম/লিটার
`; // <-- উপরে কয়েক লাইন দেখানো; প্রকৃত কোডে ৪০০ রো এমবেড আছে

/* 2) Synthetic 11k builder (stress test) */
function buildDemoCSV11000(){
  const header = "ফসল,রোগ/পোকা,সাধারণ নাম,ব্র্যান্ড নাম,প্রয়োগ মাত্রা";
  const base = [
    ["কলা","সিগাটোকা","হেক্সাকোনাজোল","ব্লেজোল ৫ইসি","১ মিলি/লিটার"],
    ["কলা","ছিদ্রকারী পোকা","ক্লোরপাইরিফস","ডার্সবান ২০ইসি","২ মিলি/লিটার"],
    ["ধান","ব্লাস্ট","ট্রাইসাইক্লাজোল","ব্লাজো ৭৫ডব্লিউপি","১ গ্রাম/লিটার"],
    ["ধান","পাতাঝল","প্রোপিকোনাজোল","টিল্ট ২৫ইসি","১ মিলি/লিটার"],
    ["ধান","স্টেম বোরার","ক্লোরান্ট্রানিলিপ্রোল","করাগান্টা ২০এসসি","০.৩ মিলি/লিটার"],
    ["গম","পাতাঝল","টেবুকোনাজোল","ফলিকিউর ২৫ইসি","১ মিলি/লিটার"],
    ["সবজি","লিফ মাইনার","অ্যাবামেক্টিন","ভার্টিমেক ১.৮ইসি","০.৫ মিলি/লিটার"],
    ["সবজি","মাইট","প্রোপারগাইট","ওমাইট ৫৭ইসি","১ মিলি/লিটার"],
    ["পেঁয়াজ","থ্রিপস","স্পিনোস্যাড","ট্রেসার ৪৫এসসি","০.২৫ মিলি/লিটার"],
    ["বেগুন","বিএফএসবি","সাইপারমেথ্রিন","সাইপার ১০ইসি","১ মিলি/লিটার"],
    ["আলু","লেট ব্লাইট","ম্যানকোজেব","ডাইথেন এম-৪৫","২ গ্রাম/লিটার"],
    ["আলু","আর্লি ব্লাইট","ক্লোরোথালোনিল","ড্যাকোনিল ৭৫ডব্লিউপি","২ গ্রাম/লিটার"],
    ["টমেটো","টিএসএম (মাইট)","অ্যাবামেক্টিন","ভার্টিমেক ১.৮ইসি","০.৫ মিলি/লিটার"],
    ["টমেটো","ফল পচা","কারবেন্ডাজিম","বাভিস্টিন ৫০ডব্লিউপি","১ গ্রাম/লিটার"],
    ["চা","লোপার","ল্যাম্বডা-সাইহ্যালোথ্রিন","করাটে ২.৫ডব্লিউজি","০.৫ গ্রাম/লিটার"]
  ];
  const out = [header];
  for(let i=0;i<11000;i++){
    const b = base[i % base.length].slice();
    b[3] = b[3] + " #" + (i+1);
    out.push(b.join(","));
  }
  return out.join("\n");
}

/* ===========================
   Startup
=========================== */
loadLogo();
loadLogin();
parseCSVText(demoCSVFromExcel); // Load sample so dropdowns ready
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ backdrop.style.display='none'; regBackdrop.style.display='none'; loginBackdrop.style.display='none'; }});
</script>
</body>
</html>
